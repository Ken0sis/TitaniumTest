var DATABASE_NAME="todo";exports.createDb=function(){Ti.Database.install("todo.sqlite",DATABASE_NAME)},exports.selectByDone=function(e){for(var a=[],o=Ti.Database.open(DATABASE_NAME),t=o.execute("select * from todo where Done = ?",e);t.isValidRow();)a.push({timeStamp:t.fieldByName("TimeStamp"),taskID:t.fieldByName("TaskID"),item:t.fieldByName("Item"),category:t.fieldByName("Category"),done:t.fieldByName("Done"),positionID:t.fieldByName("PositionID"),dueDate:t.fieldByName("DueDate"),dueDelta:t.fieldByName("DueDelta"),loadSigma:t.fieldByName("LoadSigma"),loadDelta:t.fieldByName("LoadDelta"),workSigma:t.fieldByName("WorkSigma"),workDelta:t.fieldByName("WorkDelta"),goalID:t.fieldByName("GoalID"),goalGuide:t.fieldByName("GoalGuide"),goalType:t.fieldByName("GoalType"),goalProgress:t.fieldByName("GoalProgress")}),t.next();return o.close(),a},exports.updateItem=function(e,a){var o=Ti.Database.open(DATABASE_NAME);o.execute("update todo set Done = ? where TaskID = ?",a,e);var t=o.execute("select * from todo where Done = ?",a);return o.close(),t},exports.addItem=function(e,a,o,t){var l=Ti.Database.open(DATABASE_NAME),r=(new Date).getTime(),i=(new Date).getTime()+Math.floor(1e3*Math.random()),m=Math.floor(Math.random()*o),d=Math.floor(2*Math.random())+1;1>m&&(m+=1),l.execute("insert into todo (Item,Category,LoadSigma,DueDate,TaskID, GoalGuide, GoalType, GoalID) values (?,?,?,?,?,?,?,?)",e,a,o,t,r,m,d,i),l.close()},exports.deleteItem=function(e){var a=Ti.Database.open(DATABASE_NAME);a.execute("delete from todo where TaskID = ?",e),a.close()},exports.selectByID=function(e){for(var a=[],o=Ti.Database.open(DATABASE_NAME),t=o.execute("select * from todo where TaskID = ?",e);t.isValidRow();)a.push({timeStamp:t.fieldByName("TimeStamp"),taskID:t.fieldByName("TaskID"),item:t.fieldByName("Item"),category:t.fieldByName("Category"),done:t.fieldByName("Done"),positionID:t.fieldByName("PositionID"),dueDate:t.fieldByName("DueDate"),dueDelta:t.fieldByName("DueDelta"),loadSigma:t.fieldByName("LoadSigma"),loadDelta:t.fieldByName("LoadDelta"),workSigma:t.fieldByName("WorkSigma"),workDelta:t.fieldByName("WorkDelta"),goalID:t.fieldByName("GoalID"),goalGuide:t.fieldByName("GoalGuide"),goalType:t.fieldByName("GoalType"),goalProgress:t.fieldByName("GoalProgress")}),t.next();return o.close(),a},exports.getTotalRewards=function(){var e=Ti.Database.open(DATABASE_NAME),a=0,o=e.execute("select TotalReward from rewards where TimeStamp = (select max(TimeStamp) from rewards)");return a=o.fieldByName("TotalReward"),e.close(),a},exports.addWork=function(e){var a=Ti.Database.open(DATABASE_NAME),o=new Date,t=Math.floor(o/864e5+2440587.5),l=(o.getHours(),a.execute("select * from todo where TaskID = ?",e)),r=l.fieldByName("LoadSigma")>0?Math.min(.5,l.fieldByName("LoadSigma")):.5,i=a.execute("select max(TimeStamp) from history"),m=Math.max(l.fieldByName("LoadSigma")-r,0),d=l.fieldByName("WorkSigma")+r,s=l.fieldByName("GoalProgress")>=100?Math.max(l.fieldByName("GoalType")-1,1):l.fieldByName("GoalType"),n=l.fieldByName("GoalProgress")>=100?Math.min(l.fieldByName("LoadSigma"),Math.max(Math.floor(.5*l.fieldByName("Goalguide")),1)):l.fieldByName("Goalguide"),y=l.fieldByName("GoalProgress")>=100?(new Date).getTime():l.fieldByName("GoalID"),D=a.execute("select sum(WorkDelta) from history where GoalID = ?",y),f=0==n?0:(D.fieldByName("sum(WorkDelta)")+r)/n*100;a.execute("UPDATE todo SET WorkDelta=?, LoadSigma=?, WorkSigma=?, GoalProgress=?, GoalGuide = ?, GoalType = ?, GoalID = ? WHERE TaskID=?",r,m,d,f,n,s,y,e),a.execute("INSERT into history (TaskID, Item, Category, Done, PositionID, DueDate, DueDelta, LoadSigma, LoadDelta, WorkSigma, WorkDelta, GoalID, GoalGuide, GoalType, GoalProgress) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",l.fieldByName("TaskID"),l.fieldByName("Item"),l.fieldByName("Category"),l.fieldByName("Done"),l.fieldByName("PositionID"),l.fieldByName("DueDate"),l.fieldByName("DueDelta"),m,l.fieldByName("LoadDelta"),d,r,y,n,s,f);var u=a.execute("select max(TimeStamp) from rewards where Combo1Reward > ?",0),B=a.execute("select max(TimeStamp) from rewards where Combo2Reward > ?",0),T=a.execute("select count(EarlyReward) from rewards where (cast(julianday(TimeStamp) as integer) = ? and strftime ('%H', TimeStamp) >= ? and strftime ('%H', TimeStamp) <= ?)",t,5,12),g=a.execute("select sum(WorkDelta) from history where (cast(julianday(TimeStamp) as integer) = ? and strftime ('%H', TimeStamp) >= ? and strftime ('%H', TimeStamp) <= ?)",t,5,12),N=a.execute("select sum(WorkDelta) from history where GoalType = ? and cast(julianday(TimeStamp) as integer) = ?",3,t),c=a.execute("select sum(WorkDelta) from history where GoalType = ? and cast(julianday(TimeStamp) as integer) = ?",2,t),p=a.execute("select sum(GoalGuide*(1-GoalProgress/100)) from todo where GoalType = ?",3),w=a.execute("select sum(GoalGuide*(1-GoalProgress/100)) from todo where GoalType = ?",2),S=a.execute("select TotalReward from rewards where TimeStamp = (select max(TimeStamp) from rewards)"),G={goalProgress:f,lastUpdate:i.fieldByName("max(TimeStamp)"),lastCombo1Re:u.fieldByName("max(TimeStamp)"),lastCombo2Re:B.fieldByName("max(TimeStamp)"),totalEarlyRe:T.fieldByName("count(EarlyReward)"),totalEarlyHrs:g.fieldByName("sum(WorkDelta)"),redWrkToday:N.fieldByName("sum(WorkDelta)"),orangeWrkToday:c.fieldByName("sum(WorkDelta)"),redBalance:p.fieldByName("sum(GoalGuide*(1-GoalProgress/100))"),orangeBalance:w.fieldByName("sum(GoalGuide*(1-GoalProgress/100))"),totalRewards:S.fieldByName("TotalReward")},k={Work:5,Combo2:0,Goal:0,Early:0,Combo1:0,DoneRed:0,DoneOrange:0,Total:0};G.goalProgress>=100&&(k.Goal=5*n),G.totalEarlyRe<G.totalEarlyHrs&&(k.Early=5*Math.floor(G.totalEarlyHrs-G.totalEarlyRe)),o.getTime()-Date.parse(G.lastUpdateTime)>24e5&&o.getTime()-Date.parse(G.lastCombo1Re)>24e5&&(k.Combo1=10),Math.floor(G.lastUpdate/864e5+2440587.5)>t&&o.getTime()-Date.parse(G.lastUpdateTime)>216e5&&(k.Combo2=.5*G.totalRewards),null==G.redBalance&&G.redWrkToday>0&&(k.DoneRed=G.redWrkToday/12*160),null==G.orangeBalance&&G.orangeWrkToday>0&&null==G.redBalance&&(k.DoneOrange=G.orangeWrkToday/12*120),k.Total=G.totalRewards+k.Work+k.Goal+k.Early+k.Combo1+k.Combo2+k.DoneRed+k.DoneOrange,a.execute("insert into rewards (TaskID, Category, Item, WorkReward, GoalReward, EarlyReward, Combo1Reward, Combo2Reward, DoneRedReward, DoneOrangeReward, TotalReward) values (?,?,?,?,?,?,?,?,?,?,?)",l.fieldByName("TaskID"),l.fieldByName("Category"),l.fieldByName("Item"),k.Work,k.Goal,k.Early,k.Combo1,k.Combo2,k.DoneRed,k.DoneOrange,k.Total);for(var I=[],x=a.execute("select * from history where TimeStamp = (select max(TimeStamp) from history)");x.isValidRow();)I.push({timeStamp:x.fieldByName("TimeStamp"),taskID:x.fieldByName("TaskID"),item:x.fieldByName("Item"),category:x.fieldByName("Category"),done:x.fieldByName("Done"),positionID:x.fieldByName("PositionID"),dueDate:x.fieldByName("DueDate"),dueDelta:x.fieldByName("DueDelta"),loadSigma:x.fieldByName("LoadSigma"),loadDelta:x.fieldByName("LoadDelta"),workSigma:x.fieldByName("WorkSigma"),workDelta:x.fieldByName("WorkDelta"),goalID:x.fieldByName("GoalID"),goalGuide:x.fieldByName("GoalGuide"),goalType:x.fieldByName("GoalType"),goalProgress:x.fieldByName("GoalProgress")}),x.next();return a.close(),console.log(I),k};